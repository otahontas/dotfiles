#!/bin/sh
# Global pre-commit hook - loads config and runs enabled modules

HOOKS_LIB="$HOME/.config/git/hooks-lib"
REPO_CONFIG="$(git rev-parse --show-toplevel)/.githooks-config"

# Default config (if no .githooks-config exists)
HOOK_GITLEAKS=1
HOOK_LLM_CHECK=0
HOOK_TESTS=0

# Load repo-specific config if exists
if [ -f "$REPO_CONFIG" ]; then
    echo "üìã Loading repo-specific hook config from .githooks-config"
    . "$REPO_CONFIG"
else
    echo "üìã Using default hook config (no .githooks-config found)"
fi

echo ""
echo "=== Pre-commit hooks ==="

# Track if any hook failed
HOOK_FAILED=0

# Source and run enabled hooks
if [ "$HOOK_GITLEAKS" = "1" ]; then
    . "$HOOKS_LIB/gitleaks.sh"
    if ! run_gitleaks; then
        HOOK_FAILED=1
    fi
    echo ""
fi

if [ "$HOOK_LLM_CHECK" = "1" ]; then
    . "$HOOKS_LIB/llm-check.sh"
    if ! run_llm_check; then
        HOOK_FAILED=1
    fi
    echo ""
fi

if [ "$HOOK_TESTS" = "1" ]; then
    echo "üß™ Running tests..."
    echo "‚ö†Ô∏è  Tests hook not yet implemented"
    echo "   Add test command to .githooks-config or implement tests.sh module"
    echo ""
fi

echo "=== Pre-commit hooks complete ==="
echo ""

# Exit with failure if any hook failed
if [ $HOOK_FAILED -eq 1 ]; then
    echo "‚ùå Pre-commit hooks failed"
    exit 1
fi

echo "‚úÖ All pre-commit hooks passed"
exit 0
