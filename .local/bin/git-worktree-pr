#!/usr/bin/env bash
set -e

if [ -z "$1" ]; then
  echo "Usage: git-worktree-pr PR_NUMBER"
  echo ""
  echo "Checks out a GitHub PR for review in an isolated worktree."
  echo "Automatically handles git-crypt if present."
  exit 1
fi

PR_NUMBER="$1"
REPO_ROOT="$(git rev-parse --show-toplevel 2>/dev/null || { echo "Error: Not in a git repository"; exit 1; })"
PROJECT_NAME="$(basename "$REPO_ROOT")"
BRANCH_NAME="pr-$PR_NUMBER"

# Detect git-crypt
HAS_GIT_CRYPT=false
if [ -d "$REPO_ROOT/.git/git-crypt" ]; then
  HAS_GIT_CRYPT=true
  echo "Detected git-crypt encryption"
fi

# Determine worktree location following skill priority
if [ -d "$REPO_ROOT/.worktrees" ]; then
  WORKTREE_PATH="$REPO_ROOT/.worktrees/$BRANCH_NAME"
elif [ -d "$REPO_ROOT/worktrees" ]; then
  WORKTREE_PATH="$REPO_ROOT/worktrees/$BRANCH_NAME"
else
  WORKTREE_PATH="$HOME/.config/superpowers/worktrees/$PROJECT_NAME/$BRANCH_NAME"
  mkdir -p "$HOME/.config/superpowers/worktrees/$PROJECT_NAME"
fi

echo "Fetching PR #$PR_NUMBER..."

# Fetch the PR branch from GitHub
git fetch origin "pull/$PR_NUMBER/head:$BRANCH_NAME" 2>&1 | grep -v "^From" || true

echo "Creating worktree for PR #$PR_NUMBER..."

# Create worktree (with git-crypt bypass if needed)
if [ "$HAS_GIT_CRYPT" = true ]; then
  git -c filter.git-crypt.smudge=cat -c filter.git-crypt.clean=cat worktree add "$WORKTREE_PATH" "$BRANCH_NAME"

  # Symlink git-crypt directory
  ln -s "$REPO_ROOT/.git/git-crypt" "$REPO_ROOT/.git/worktrees/$BRANCH_NAME/git-crypt"

  # Navigate and checkout files (decrypts them)
  cd "$WORKTREE_PATH"
  git checkout -- . 2>/dev/null || true
else
  git worktree add "$WORKTREE_PATH" "$BRANCH_NAME"
  cd "$WORKTREE_PATH"
fi

# Verify status
STATUS=$(git status --short)
if [ -n "$STATUS" ]; then
  echo "Warning: Worktree has uncommitted changes:"
  echo "$STATUS"
fi

echo ""
echo "✓ PR #$PR_NUMBER checked out successfully"
echo "✓ Location: $WORKTREE_PATH"
if [ "$HAS_GIT_CRYPT" = true ]; then
  echo "✓ Files decrypted"
fi
echo ""
echo "Next steps:"
echo "  cd $WORKTREE_PATH"
if [ -f "$WORKTREE_PATH/package.json" ]; then
  echo "  npm ci"
fi
echo ""
echo "To view PR in browser:"
echo "  gh pr view $PR_NUMBER --web"
